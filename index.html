<!DOCTYPE html>
<html>
<head>
	<base href="/">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mtg Cube Builder</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css" integrity="sha384-cg6SkqEOCV1NbJoCu11+bm0NvBRc8IYLRGXkmNrqUBfTjmMYwNKPWBTIKyw9mHNJ" crossorigin="anonymous">
    <style>
.selected-list li {
    list-style-type: none;
}
.selected-element div {
    list-style-type: none;
    display: inline-block;
    padding: 5px 10px;
}
.list-element-mana {
    vertical-align: middle;
}
    </style>


</head>
<body>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    <script>

var root = document.body
var localStorage = window.localStorage;

var endpoint = "https://api.magicthegathering.io/v1/cards";
var setCode = "DOM";
var g_data = [];
var g_selected = {};
var g_pageLength = 50;

var mutex = false;

function getSymbolImage(name) { return "http://gatherer.wizards.com/Handlers/Image.ashx?size=medium&name="+name+"&type=symbol"; }

function getFrenchData(foreignNames) {
    let numLanguage = foreignNames.length
    for (let j = 0; j < numLanguage; j++) {
        if (foreignNames[j].language == "French") {
            return [foreignNames[j].name, foreignNames[j].imageUrl];
        }
    }
}

function CreateManaCost(manaCost) {
    let r = /{(.+?)}/g;
    let match;
    let symbolList = [];
    while ((match = r.exec(manaCost)) != null) {
        symbolList.push(match[1]);
    }

    return {
        view: function (vnode) {
            // with no cache in browser image is redraw on each click (so deactive no-cache option)
            return m(".list-element-mana", [
                        symbolList.map(function(symbolName) {
                            return m("img.mana-symbol", {src:getSymbolImage(symbolName)}, symbolName);
                        })
                    ]);
        }
    }
};

function CreateCard(name, url, number) {
    return {
        view: function (vnode) {
            // with no cache in browser image is redraw on each click (so deactive no-cache option)
            return m("img.pure-img", {src:url, onclick: function() {g_selected[name].quantity += 1}}, name);
        }
    }
};

function CreateListElement(name, element) {
    return {
        view: function (vnode) {
            return m(".selected-element", [
                m(".list-element-quantity", {onclick: function() {g_selected[name].quantity += 1}}, element.quantity),
                m(".list-element-name", {onclick: function() {g_selected[name].quantity -= 1}}, name),
                m(CreateManaCost(element.manaCost))
            ]);
        }
    }
};

// "https://api.magicthegathering.io/v1/cards?set=DOM&page=1&pageSize=5&orderBy=number
var Client = {
    oninit: function(vnode) {
        var requestLength = 0;
        if (!("cardList" in localStorage)) {
            m.request({
                method: "GET",
                url: endpoint + "?set=" + setCode + "&page=0&pageSize=" + g_pageLength + "&orderBy=number",
            })
            .then(function(data) {

                requestLength = data.cards.length;
                for (let i = 0; i < requestLength; i++) {
                    let card = data.cards[i];
                    let [name, imageUrl] = getFrenchData(card.foreignNames);
                    g_data.push({"name": name, "imageUrl": imageUrl, "number": card.number});
                    g_selected[name] = {"quantity": 0, "manaCost": card.manaCost};
                }
                localStorage.setItem("cardList", JSON.stringify(g_data));
                localStorage.setItem("selectedList", JSON.stringify(g_selected));
                mutex = true;
            })
        } else {
            console.log("Get data from localStorage");
            g_data = JSON.parse(localStorage.getItem("cardList"));
            g_selected = JSON.parse(localStorage.getItem("selectedList"));
            mutex = true;
        }

    },
    view: function(vnode) {
        return m("main", {class: "main"}, [
            m("h1", {class: "small-margin-bottom"}, "Mtg Cube Builder"),
            m(".pure-g", [
                m(".pure-u-1-2",
                    m(".pure-g#card-list", [
                        g_data.map(function(card) {
                            return m(".pure-u-1-6", m(CreateCard(card.name, card.imageUrl)))
                        })
                    ])
                ),
                m(".pure-u-1-2",
                    m("ul.selected-list", [
                    Object.keys(g_selected).map(function(key, index) {
                            return g_selected[key].quantity > 0 ? m("li", m(CreateListElement(key, g_selected[key]))) : null;
                        })
                    ])
                )
            ])
        ])
    }
}

m.mount(root, Client)

function populate() {

    let windowRelativeBottom = document.documentElement.getBoundingClientRect().bottom;
    if (windowRelativeBottom < document.documentElement.clientHeight + 100) {
        if (mutex == false) {
            return;
        }
        mutex = false;

        // Calculate pageIndex
        let pageIndex = Math.trunc(g_data.length / g_pageLength) + 1
        console.log("pageIndex :", pageIndex);

        m.request({
            method: "GET",
            url: endpoint + "?set=" + setCode + "&page=" + pageIndex +"&pageSize=" + g_pageLength + "&orderBy=number",
        })
        .then(function(data) {
            requestLength = data.cards.length;
            for (let i = 0; i < requestLength; i++) {
                let card = data.cards[i];
                let [name, imageUrl] = getFrenchData(card.foreignNames);
                g_data.push({"name": name, "imageUrl": imageUrl, "number": card.number});
                g_selected[name] = {"quantity": 0, "manaCost": card.manaCost};
            }
            localStorage.setItem("cardList", JSON.stringify(g_data));
            localStorage.setItem("selectedList", JSON.stringify(g_selected));
            mutex = true;
        })
    }
}

window.addEventListener('scroll', populate);

    </script>
</body>
</html>