<!DOCTYPE html>
<html>
<head>
	<base href="/">
	<meta charset="utf-8">
	<meta http-equiv="X-UA-compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mtg Cube Builder</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css" integrity="sha384-cg6SkqEOCV1NbJoCu11+bm0NvBRc8IYLRGXkmNrqUBfTjmMYwNKPWBTIKyw9mHNJ" crossorigin="anonymous">
</head>
<body>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    <script>

var root = document.body

var endpoint = "https://api.magicthegathering.io/v1/cards";
var setCode = "DOM";
var g_data = [];
var g_selected = {};

function getFrenchData(foreignNames) {
    let numLanguage = foreignNames.length
    for (let j = 0; j < numLanguage; j++) {
        if (foreignNames[j].language == "French") {
            return [foreignNames[j].name, foreignNames[j].imageUrl];
        }
    }
}

function CreateCard(name, url, number) {
    return {
        view: function (vnode) {
            // with no cache in browser image is redraw on each click (so deactive no-cache option)
            return m("img.pure-img", {src:url, onclick: function() {g_selected[name] += 1}}, name);
        }
    }
};

function CreateListElement(name, quantity) {
    return {
        view: function (vnode) {
            return m(".", [
                m(".list-element-quantity", {onclick: function() {g_selected[name] += 1}}, quantity),
                m(".list-element-name", {onclick: function() {g_selected[name] -= 1}}, name)
            ]);
        }
    }
};

// "https://api.magicthegathering.io/v1/cards?set=DOM&page=1&pageSize=5&orderBy=number
var Client = {
    oninit: function(vnode) {
        console.log("debug_oninit");
        var requestLength = 0;
        var pageLength = 5;
        var pageIndex = 0

        m.request({
            method: "GET",
            url: endpoint + "?set=" + setCode + "&page=" + pageIndex +"&pageSize=" + pageLength + "&orderBy=number",
        })
        .then(function(data) {

            console.log(data);
            requestLength = data.cards.length;
            for (let i = 0; i < requestLength; i++) {
                let foreignNames = data.cards[i].foreignNames;
                let numLanguage = foreignNames.length
                let [name, imageUrl] = getFrenchData(foreignNames);
                g_data.push({"name": name, "imageUrl": imageUrl, "number": data.cards[i].name});
                g_selected[name] = 0;
            }
            pageIndex++;
        })

        console.log("debug");
    },
    view: function(vnode) {
        return m("main", {class: "main"}, [
            m("h1", {class: "small-margin-bottom"}, "Mtg Cube Builder"),
            m(".pure-g", [
                m(".pure-u-1-2",
                    m(".pure-g#card-list", [
                        g_data.map(function(card) {
                            return m(".pure-u-1-6", m(CreateCard(card.name, card.imageUrl)))
                        })
                    ])
                ),
                m(".pure-u-1-2",
                    m("ul#selected-list", [
                    Object.keys(g_selected).map(function(key, index) {
                            return g_selected[key] > 0 ? m("li", m(CreateListElement(key, g_selected[key]))) : null;
                        })
                    ])
                )
            ])
        ])
    }
}

m.mount(root, Client)

    </script>
</body>
</html>